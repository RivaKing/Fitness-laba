{% extends "base.html" %}

{% block title %}{{ training.title }} - Фитнес Платформа{% endblock %}

{% block extra_css %}
<style>
    .training-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 3rem 0;
        color: white;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
    }
    
    .training-image {
        height: 300px;
        object-fit: cover;
        border-radius: 10px;
    }
    
    .info-card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 1rem;
    }
    
    .info-card .card-header {
        background: #f8f9fa;
        border-bottom: 2px solid #4e73df;
        font-weight: 600;
    }
    
    .status-badge {
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
    }
    
    .rating-stars {
        color: #ffc107;
        font-size: 1.2rem;
    }
    
    .admin-actions {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Заголовок тренировки -->
<div class="training-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent p-0">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('trainings.training_list') }}" class="text-white text-decoration-none">
                                <i class="fas fa-running"></i> Тренировки
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-white" aria-current="page">{{ training.title }}</li>
                    </ol>
                </nav>
                
                <h1 class="display-5 fw-bold">{{ training.title }}</h1>
                
                <div class="d-flex align-items-center gap-3 mb-3">
                    {% if training.category %}
                    <span class="badge bg-primary status-badge">{{ training.category.name }}</span>
                    {% endif %}
                    
                    <span class="badge 
                        {% if training.status == 'active' %}bg-success
                        {% elif training.status == 'completed' %}bg-secondary
                        {% elif training.status == 'cancelled' %}bg-danger
                        {% elif training.status == 'draft' %}bg-warning text-dark
                        {% elif training.status == 'pending' %}bg-info text-white
                        {% elif training.status == 'rejected' %}bg-danger
                        {% else %}bg-secondary{% endif %} status-badge">
                        {% if training.status == 'active' %}АКТИВНА
                        {% elif training.status == 'completed' %}ЗАВЕРШЕНА
                        {% elif training.status == 'cancelled' %}ОТМЕНЕНА
                        {% elif training.status == 'draft' %}ЧЕРНОВИК
                        {% elif training.status == 'pending' %}НА ПРОВЕРКЕ
                        {% elif training.status == 'rejected' %}ОТКЛОНЕНА
                        {% else %}{{ training.status|upper }}{% endif %}
                    </span>
                    
                    <span class="badge bg-info status-badge">{{ training.training_type|upper }}</span>
                    
                    {% if training.difficulty %}
                    <span class="badge bg-dark status-badge">
                        {% if training.difficulty == 'beginner' %}Начинающий
                        {% elif training.difficulty == 'intermediate' %}Средний
                        {% else %}Продвинутый{% endif %}
                    </span>
                    {% endif %}
                </div>
                
                <div class="d-flex align-items-center gap-4 text-white-50">
                    <div>
                        <i class="fas fa-user-tie me-1"></i>
                        Тренер: {{ training.trainer_user.username }}
                    </div>
                    <div>
                        <i class="fas fa-calendar-alt me-1"></i>
                        {{ training.schedule_time|format_datetime }}
                    </div>
                    <div>
                        <i class="fas fa-clock me-1"></i>
                        {{ training.duration }} минут
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 text-end">
                <!-- Действия -->
                <div class="btn-group-vertical gap-2">
                    {% if current_user.is_authenticated %}
                        {% set registration = training.registrations.filter_by(user_id=current_user.id).first() %}
                        
                        {% if registration %}
                            <!-- Если есть активная регистрация -->
                            {% if registration.status == 'registered' %}
                                {% if registration.can_be_cancelled %}
                                <form method="POST" action="{{ url_for('trainings.cancel_registration', training_id=training.id) }}">
                                    <button type="submit" class="btn btn-danger w-100">
                                        <i class="fas fa-times-circle me-2"></i>Отменить запись
                                    </button>
                                </form>
                                {% else %}
                                <button class="btn btn-secondary w-100" disabled>
                                    <i class="fas fa-ban me-2"></i>Отмена невозможна
                                </button>
                                {% endif %}
                                
                                {% if training.meeting_link %}
                                <a href="{{ training.meeting_link }}" target="_blank" class="btn btn-success w-100">
                                    <i class="fas fa-video me-2"></i>Присоединиться
                                </a>
                                {% endif %}
                                
                            <!-- Если тренировка посещена и можно оставить отзыв -->
                            {% elif registration.status == 'attended' and not feedback %}
                                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                    <i class="fas fa-star me-2"></i>Оставить отзыв
                                </button>
                                
                            <!-- Если тренировка посещена -->
                            {% elif registration.status == 'attended' %}
                                <button class="btn btn-outline-light w-100" disabled>
                                    <i class="fas fa-check-circle me-2"></i>Посещено
                                </button>
                                
                            <!-- Если регистрация отменена (но не удалена из БД) -->
                            {% elif registration.status == 'cancelled' and training.is_upcoming and not training.is_full %}
                                <form method="POST" action="{{ url_for('trainings.register', training_id=training.id) }}">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-redo me-2"></i>Записаться снова
                                    </button>
                                </form>
                            {% endif %}
                            
                        <!-- Нет регистрации, можно записаться -->
                        {% elif training.trainer_user_id != current_user.id and training.is_upcoming and not training.is_full and training.status == 'active' %}
                            <form method="POST" action="{{ url_for('trainings.register', training_id=training.id) }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-calendar-plus me-2"></i>Записаться
                                </button>
                            </form>
                        {% endif %}
                        
                    <!-- Не авторизован -->
                    {% else %}
                        <a href="{{ url_for('auth.login') }}?next={{ request.path }}" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Войти для записи
                        </a>
                    {% endif %}
                    
                    {% if training.video_link %}
                    <a href="{{ training.video_link }}" target="_blank" class="btn btn-outline-light w-100">
                        <i class="fas fa-play-circle me-2"></i>Видео
                    </a>
                    {% endif %}
                </div>
                
                <!-- Действия администратора -->
                {% if current_user.is_authenticated and current_user.role == 'admin' and training.status in ['draft', 'pending'] %}
                <div class="admin-actions">
                    <h6 class="text-white mb-3"><i class="fas fa-user-shield me-2"></i>Действия администратора</h6>
                    
                    <div class="btn-group-vertical gap-2 w-100">
                        <form method="POST" action="{{ url_for('trainings.approve_training', training_id=training.id) }}">
                            <button type="submit" class="btn btn-success w-100" 
                                    onclick="return confirm('Одобрить тренировку «{{ training.title }}»?')">
                                <i class="fas fa-check-circle me-2"></i>Одобрить тренировку
                            </button>
                        </form>
                        
                        <button type="button" class="btn btn-danger w-100" 
                                data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="fas fa-times-circle me-2"></i>Отклонить тренировку
                        </button>
                        
                        <a href="{{ url_for('trainings.admin_pending_trainings') }}" class="btn btn-outline-light w-100">
                            <i class="fas fa-tasks me-2"></i>Все на проверке
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <!-- Основная информация -->
        <div class="col-lg-8">
            <!-- Информация об одобрении/отклонении (только для админа и тренера) -->
            {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.id == training.trainer_user_id) and training.status != 'active' %}
            <div class="card info-card mb-4 border-{% if training.status == 'rejected' %}danger{% else %}warning{% endif %}">
                <div class="card-header bg-{% if training.status == 'rejected' %}danger text-white{% else %}warning{% endif %}">
                    <i class="fas fa-info-circle me-2"></i>
                    {% if training.status == 'draft' %}Статус: Черновик
                    {% elif training.status == 'pending' %}Статус: Ожидает проверки
                    {% elif training.status == 'rejected' %}Статус: Отклонена
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if training.status == 'draft' %}
                    <p class="mb-0">
                        <i class="fas fa-clock me-2 text-warning"></i>
                        Эта тренировка находится в черновике и не видна клиентам.
                        {% if current_user.id == training.trainer_user_id %}
                        Вы можете редактировать её в любое время.
                        {% endif %}
                    </p>
                    {% elif training.status == 'pending' %}
                    <p class="mb-0">
                        <i class="fas fa-hourglass-half me-2 text-info"></i>
                        Эта тренировка отправлена на проверку администратору.
                        После одобрения она станет доступна для записи клиентам.
                    </p>
                    {% elif training.status == 'rejected' %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Тренировка отклонена</h6>
                        {% if training.rejection_reason %}
                        <p class="mb-2"><strong>Причина отклонения:</strong> {{ training.rejection_reason }}</p>
                        {% endif %}
                        {% if training.rejected_at %}
                        <p class="mb-0"><strong>Дата отклонения:</strong> {{ training.rejected_at|format_datetime }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Описание -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>Описание
                </div>
                <div class="card-body">
                    {% if training.description %}
                        {{ training.description|safe }}
                    {% else %}
                        <p class="text-muted mb-0">Описание тренировки отсутствует.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Детали -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card info-card h-100">
                        <div class="card-header">
                            <i class="fas fa-clock me-2"></i>Расписание
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <strong>Дата и время:</strong><br>
                                    {{ training.schedule_time|format_datetime('%d.%m.%Y %H:%M') }}
                                </li>
                                <li class="mb-2">
                                    <strong>Длительность:</strong><br>
                                    {{ training.duration }} минут
                                </li>
                                <li class="mb-2">
                                    <strong>Часовой пояс:</strong><br>
                                    {{ training.timezone }}
                                </li>
                                {% if training.meeting_link %}
                                <li class="mb-2">
                                    <strong>Ссылка для подключения:</strong><br>
                                    <a href="{{ training.meeting_link }}" target="_blank" class="text-decoration-none">
                                        Перейти к конференции
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card info-card h-100">
                        <div class="card-header">
                            <i class="fas fa-users me-2"></i>Участники
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <strong>Участники:</strong><br>
                                    {{ training.registrations.filter_by(status='registered').count() }} из {{ training.max_participants }}
                                </li>
                                <li class="mb-2">
                                    <strong>Минимальный возраст:</strong><br>
                                    {{ training.age_limit_min or 'Не ограничено' }}
                                </li>
                                <li class="mb-2">
                                    <strong>Максимальный возраст:</strong><br>
                                    {{ training.age_limit_max or 'Не ограничено' }}
                                </li>
                                {% if training.price > 0 %}
                                <li class="mb-2">
                                    <strong>Стоимость:</strong><br>
                                    {{ training.price }} {{ training.currency }}
                                </li>
                                {% else %}
                                <li class="mb-2">
                                    <strong>Стоимость:</strong><br>
                                    Бесплатно
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Оборудование и ограничения -->
            <div class="row">
                {% if equipment %}
                <div class="col-md-6 mb-4">
                    <div class="card info-card h-100">
                        <div class="card-header">
                            <i class="fas fa-dumbbell me-2"></i>Необходимое оборудование
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                {% for item in equipment %}
                                <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if contraindications %}
                <div class="col-md-6 mb-4">
                    <div class="card info-card h-100">
                        <div class="card-header">
                            <i class="fas fa-exclamation-triangle me-2"></i>Противопоказания
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                {% for item in contraindications %}
                                <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Отзывы -->
            <div class="card info-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-star me-2"></i>Отзывы
                        {% if avg_ratings.overall %}
                        <span class="rating-stars ms-2">
                            {{ "★" * avg_ratings.overall|int }}{{ "☆" * (5 - avg_ratings.overall|int) }}
                            ({{ avg_ratings.overall|round(1) }})
                        </span>
                        {% endif %}
                    </div>
                    <small class="text-muted">{{ training.total_ratings }} отзывов</small>
                </div>
                <div class="card-body">
                    {% if feedbacks %}
                        {% for feedback in feedbacks %}
                        <div class="mb-4 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong>
                                        {% if feedback.is_anonymous %}
                                        Анонимный пользователь
                                        {% else %}
                                        {{ feedback.user.username }}
                                        {% endif %}
                                    </strong>
                                    <small class="text-muted ms-2">
                                        {{ feedback.created_at|time_ago }}
                                    </small>
                                </div>
                                <span class="rating-stars">
                                    {% set rating = feedback.ratings.filter_by(rating_type='overall').first() %}
                                    {% if rating %}
                                    {{ "★" * rating.score|int }}{{ "☆" * (5 - rating.score|int) }}
                                    {% endif %}
                                </span>
                            </div>
                            <p class="mb-0">{{ feedback.comment }}</p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mb-0">Отзывов пока нет.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Боковая панель -->
        <div class="col-lg-4">
            <!-- Тренер -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <i class="fas fa-user-tie me-2"></i>Тренер
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-user-circle fa-4x text-primary"></i>
                    </div>
                    <h5>{{ training.trainer_user.username }}</h5>
                    
                    {% if training.trainer_user.trainer_info %}
                        {% set trainer = training.trainer_user.trainer_info %}
                        <p class="text-muted mb-2">
                            <i class="fas fa-briefcase me-1"></i>
                            {{ trainer.specialization or 'Специализация не указана' }}
                        </p>
                        <p class="text-muted mb-2">
                            <i class="fas fa-chart-line me-1"></i>
                            Опыт: {{ trainer.experience_years or 0 }} лет
                        </p>
                        
                        {% if trainer.rating > 0 %}
                        <p class="text-muted mb-3">
                            <i class="fas fa-star text-warning me-1"></i>
                            Рейтинг: {{ "%.1f"|format(trainer.rating) }} ({{ trainer.total_ratings }} оценок)
                        </p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-2"></i>Статистика
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-eye me-2 text-primary"></i>
                            <strong>Просмотры:</strong> {{ training.views_count }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-user-check me-2 text-success"></i>
                            <strong>Записались:</strong> {{ training.registrations_count }}
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-percentage me-2 text-info"></i>
                            <strong>Процент заполнения:</strong> 
                            {{ ((training.registrations.filter_by(status='registered').count() / training.max_participants) * 100)|round(1) }}%
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Быстрые ссылки -->
            <div class="card info-card">
                <div class="card-header">
                    <i class="fas fa-link me-2"></i>Ссылки
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if training.video_link %}
                        <a href="{{ training.video_link }}" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-play-circle me-2"></i>Видео тренировки
                        </a>
                        {% endif %}
                        
                        {% if training.materials_link %}
                        <a href="{{ training.materials_link }}" target="_blank" class="btn btn-outline-success">
                            <i class="fas fa-file-pdf me-2"></i>Материалы для подготовки
                        </a>
                        {% endif %}
                        
                        <a href="{{ url_for('trainings.training_list', category=training.category_id) if training.category_id else url_for('trainings.training_list') }}" class="btn btn-outline-info">
                            <i class="fas fa-list me-2"></i>Похожие тренировки
                        </a>
                        
                        {% if current_user.is_authenticated and current_user.role == 'admin' %}
                        <a href="{{ url_for('trainings.admin_pending_trainings') }}" class="btn btn-outline-warning">
                            <i class="fas fa-tasks me-2"></i>Тренировки на проверке
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для отзыва -->
{% if registration and registration.status == 'attended' and not feedback %}
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Оставить отзыв</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('trainings.add_feedback', training_id=training.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ваша оценка</label>
                        <div class="rating-stars mb-2" id="ratingStars">
                            {% for i in range(5, 0, -1) %}
                            <i class="far fa-star fa-2x" data-rating="{{ i }}" style="cursor: pointer;"></i>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="rating" id="selectedRating" value="5">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Комментарий</label>
                        <textarea name="comment" class="form-control" rows="4" placeholder="Расскажите о ваших впечатлениях..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Отправить отзыв</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Модальное окно для отклонения тренировки -->
{% if current_user.is_authenticated and current_user.role == 'admin' and training.status in ['draft', 'pending'] %}
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Отклонить тренировку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('trainings.reject_training', training_id=training.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Вы собираетесь отклонить тренировку <strong>"{{ training.title }}"</strong>.
                        Эта причина будет отправлена тренеру.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Причина отклонения *</label>
                        <textarea name="reason" class="form-control" rows="5" 
                                  placeholder="Укажите подробную причину отклонения тренировки..." required></textarea>
                        <div class="form-text">Объясните, что нужно исправить или почему тренировка не подходит</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-danger">Отклонить тренировку</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Рейтинг звездами
    const stars = document.querySelectorAll('#ratingStars i');
    const selectedRating = document.getElementById('selectedRating');
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            selectedRating.value = rating;
            
            // Обновляем отображение звезд
            stars.forEach(s => {
                if (parseInt(s.dataset.rating) <= rating) {
                    s.classList.remove('far');
                    s.classList.add('fas');
                } else {
                    s.classList.remove('fas');
                    s.classList.add('far');
                }
            });
        });
        
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.dataset.rating);
            
            stars.forEach(s => {
                if (parseInt(s.dataset.rating) <= rating) {
                    s.classList.add('fas');
                    s.classList.remove('far');
                }
            });
        });
        
        star.addEventListener('mouseout', function() {
            const currentRating = parseInt(selectedRating.value);
            
            stars.forEach(s => {
                if (parseInt(s.dataset.rating) > currentRating) {
                    s.classList.remove('fas');
                    s.classList.add('far');
                }
            });
        });
    });
    
    // Инициализация всех звезд как выбранных (5 по умолчанию)
    if (stars.length > 0) {
        stars.forEach(star => {
            star.classList.add('fas');
        });
    }
});
</script>
{% endblock %}